/*
 * 功能：    拓展String类型方法，添加常用功能
 * 创建人：  焰尾迭
 * 创建时间：2015-11-18
 */
$.extend(String.prototype,{format:function(e){var t=this;if(arguments.length>0)if(1==arguments.length&&"object"==typeof e){for(var a in e)if(void 0!=e[a]){var s=new RegExp("({"+a+"})","g");t=t.replace(s,e[a])}}else for(var i=0;i<arguments.length;i++)if(void 0!=arguments[i]){var s=new RegExp("({)"+i+"(})","g");t=t.replace(s,arguments[i])}return t}}),/*!
 @Name：fiterMore v1.0 互联网风格筛选条件插件
 @Author：焰尾迭
 @Site：http://yanwei.cnblogs.com
 @github: http://aui.github.com/fiterMore
 @License：LGPL
 */
function(e){e.fn.extend({fiterMore:function(t){function a(){var t="";e(_.searchBoxs).each(function(e,a){t+='<div class="searchbox-item" {0} data-id="{1}" id="{2}">'.format(e+1==_.searchBoxs.length?'style="border: 0"':"",e,a.id)+'<div class="l" id="{1}_l">{0}<i></i></div>'.format(a.title,a.id)+'<div class="c" id="{0}_c">'.format(a.id)+'<div class="control-type">({0})</div><div class="filter_option" style="padding-right:{1}px;">'.format(a.isMultiple?"多选":"单选",s(a)+20)+i(a)+"</div>"+l(e,a)+"</div>"+'<a href="javascript:;" class="r" id="{0}_r"><span class="text">展开</span><i class="fa fa-angle-double-down"></i></a>'.format(a.id)+"</div>"}),m.html(t),e(".searchbox .searchbox-item").each(function(t){var a=e(this).find(".filter_option").outerHeight();a<=30&&e(this).find(".r").remove()}),_.expandRow<_.searchBoxs.length&&m.after(x)}function s(e){return e.custom?1==e.custom.isRange?"date"==e.type?320:"datetime"==e.type?440:260:"date"==e.type?200:"datetime"==e.type?260:170:0}function i(t){var a="";(t.isMultiple||!t.isMultiple&&t.isShowAll)&&(a='<span title="全部" class="option_all {0}">全部</span>'.format(t.defaults&&0!=t.defaults.length?"":"selected"));var s=d(t),i=h;if(s&&!isNaN(t.expand.max)){var l=parseInt(t.expand.max,10);i=i>l?l:i}return e(t.data).each(function(l,n){s&&1+l>i||(a+='<span title="{0}" data-id="{1}" data-value="{3}" {2}>{0}</span>'.format(n[t.textField],l,e.inArray(n[t.valueField],t.defaults)>=0?"class='selected'":"",n[t.valueField]))}),a}function l(e,t){if(t.custom){var a="70px";"date"==t.type?a="100px":"datetime"==t.type&&(a="160px");var i='<div class="filter_custom" style="width:{0}px;"><span>自定义</span>'.format(s(t));return i+='<span><input type="text" id="{0}_c_custom_start" style="width:{1};"></span>'.format(t.id,a),t.custom.isRange&&(i+="<span>—</span>"+'<span><input type="text" id="{0}_c_custom_end" {1}></span>'.format(t.id,a?"style='width:{0}'".format(a):"")),i+='<span class="btn_filter_sure" data-id="{0}">确定</span></div>'.format(e)}return""}function n(t){return e(t).closest(".searchbox-item").attr("data-id")}function o(e){var t=n(e);return _.searchBoxs[t]}function c(){var t=[],a=null;return e(_.searchBoxs).each(function(e,s){a={},s.customSelectd.length>0?a[_.paramCustomkey]=s.customSelectd:a[_.paramkey]=s.selected,a.isMultiple=s.isMultiple,a.id=s.srcID,t.push(a)}),t}function d(e){return e.expand&&"function"==typeof e.expand.event}function r(t,a,s){function i(t){var a=e(t).find(".fa");return a.hasClass("fa-angle-double-down")?"expand":"collaspe"}t.cancelBubble=!0;var l=i(a);if(!s||s!=l){var n=e(a).find(".fa"),c=e(a).siblings(".c");if("expand"==l?(e(a).find(".text").text("收缩"),n.removeClass("fa-angle-double-down").addClass("fa-angle-double-up"),e(a).siblings(".c").css({height:"auto"})):(e(a).find(".text").text("展开"),n.removeClass("fa-angle-double-up").addClass("fa-angle-double-down"),c.css({height:30})),"展开条件"==x.find("span").text()){var r=0,u=0;e(".searchbox-item").each(function(t,a){"收缩"==e(a).find(".text").text()&&(r++,u+=e(a).find(".c").height())});var f=40*(_.expandRow-r)+9*r+u;0==r&&(f=y),m.css({height:f})}var p=o(a);d(p)&&p.expand.event(p.data,a,l)}}function u(t){t.custom&&t.customSelectd.length>0&&(t.customSelectd=[],e("#{0}_c_custom_start".format(t.id)).val(""),t.custom.isRange&&e("#{0}_c_custom_end".format(t.id)).val(""))}function f(t){t.custom&&t.customSelectd.length>0&&(e("#{0}_c_custom_start".format(t.id)).val(t.customSelectd[0]),t.custom.isRange&&e("#{0}_c_custom_end".format(t.id)).val(t.customSelectd[1]))}function p(t){function a(e,t){if(0==t.defaults.length)e.filter(".option_all").addClass("selected");else for(var a=0;a<t.defaults.length;a++)e.filter("[data-value='{0}']".format(t.defaults[a])).addClass("selected"),t.selected.push(t.defaults[a])}if(e.isArray(t)){for(var s={},i=null,l=0,n=t.length;l<n;l++)i=t[l],s[i.id]=i;var o;e(_.searchBoxs).each(function(t,l){if(i=s[l.srcID],o=e("#"+l.id).find(".filter_option span"),o.removeClass("selected"),u(l),l.selected=[],i){var n=i[_.paramkey],c=i[_.paramCustomkey];if(n&&n.length>0)for(var t=0;t<n.length;t++)o.filter("[data-value='{0}']".format(n[t])).addClass("selected"),l.selected.push(n[t]);else if(c&&c.length>0){for(var t=0;t<c.length;t++)l.customSelectd.push(c[t]);f(l)}else a(o,l)}else a(o,l)})}}var h=10,v="searchitem_",m=this,x=e('<div class="filter_btn"><span class="expand">展开条件</span></div>'),g={expandEvent:function(e){},expandRow:2,searchBoxs:[],search:function(e){},paramkey:"ValueList",paramCustomkey:"CustomList",searchOnSelect:!0},_=e.extend(g,t);if(isNaN(_.expandRow)||_.expandRow<1)throw Error("默认展开条件数'expandRow'必须为大于0的整数");_.expandRow>_.searchBoxs.length&&(_.expandRow=_.searchBoxs.length);var y=40*_.expandRow-1*(_.expandRow-1);return m.css({height:y}),e(_.searchBoxs).each(function(e,t){t.id&&"string"==typeof t.id?(t.srcID=t.id,t.id="{0}{1}".format(v,t.id)):(t.srcID=e,t.id="{0}{1}".format(v,e)),t.valueField||t.textField?(t.valueField&&!t.textField&&(t.textField=t.valueField),t.textField&&!t.valueField&&(t.valueField=t.textField)):(t.valueField="value",t.textField="text"),t.defaults||(t.defaults=[]),t.selected=[];for(var a=0;a<t.defaults.length;a++)t.selected.push(t.defaults[a]);t.customSelectd=[],void 0==t.isMultiple&&(t.isMultiple=!1),void 0==t.isShowAll&&(t.isShowAll=!0)}),a(),m.on("click select",".filter_option span",function(t){var a=o(this),s=e(this).attr("data-id"),i="select";if(0==a.isMultiple||e(this).hasClass("option_all"))e(this).addClass("selected").siblings("span").removeClass("selected"),a.selected=[],e(this).hasClass("option_all")?i="cancelall":(a.selected.push(a.data[s][a.valueField]),i="selectremove");else if(e(this).hasClass("selected")){e(this).removeClass("selected"),i="cancel";for(var l=a.data[s][a.valueField],n=0,d=a.selected.length;n<d;n++)a.selected[n]==l&&a.selected.splice(n,1);0==a.selected.length&&(e(this).siblings(".option_all").addClass("selected"),i="cancelall")}else e(this).addClass("selected"),e(this).siblings(".option_all").removeClass("selected"),a.selected.push(a.data[s][a.valueField]),i="select";u(a),"function"==typeof a.onSelect&&"click"==t.type&&a.onSelect(a.data[s],i),"function"==typeof _.search&&_.searchOnSelect&&_.search(c())}),m.on("click",".r",function(e,t){r(e,this,t)}),x.find("span").on("click",function(){var t=!0;e(this).hasClass("expand")?(e(this).text("收缩条件").removeClass("expand"),m.css({height:"auto"})):(e(this).text("展开条件").addClass("expand"),m.css({height:y}),t=!1),"function"==typeof _.expandEvent&&_.expandEvent(t)}),m.on("click",".filter_custom .btn_filter_sure",function(){var t,a=e(this).attr("data-id"),s=_.searchBoxs[a],i=e("#{0}_c_custom_start".format(s.id)).val();s.custom.isRange&&(t=e("#{0}_c_custom_end".format(s.id)).val()),("function"!=typeof s.custom.event||s.custom.event(i,t))&&(e(this).closest(".filter_custom").siblings(".filter_option").find("span").removeClass("selected"),s.selected=[],s.customSelectd[0]=i,s.custom.isRange&&(s.customSelectd[1]=t),"function"==typeof _.search&&_.search(c()))}),m.each(function(){this.getParamList=c,this.setValue=p,this.isFiterMore=!0})},getParamList:function(){var e=this[0];if(e.isSeachBox)return e.getParamList()},searchFunctionCall:function(t){if(e.isPlainObject(t)){var a=this[0];if(a.isFiterMore)for(var s in t)return e.isFunction(a[s])?a[s](t[s]):(console.error("查询插件fiterMore不支持“{0}”方法".format(s)),null)}}})}(jQuery);